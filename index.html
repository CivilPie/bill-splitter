<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="theme-color" content="#fef7ff">
    <title>Split EGP Pro</title>
    <link rel="manifest" href="manifest.json">
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --md-sys-color-primary: #6750A4;
            --md-sys-color-surface: #fef7ff;
            --md-sys-color-surface-container: #f3edf7;
            --md-sys-color-secondary-container: #e8def8;
            --md-sys-color-whatsapp: #25D366;
            --md-sys-color-error: #B3261E;
            --md-sys-color-success: #2E7D32;
            --safe-area-bottom: env(safe-area-inset-bottom, 20px);
        }

        body { 
            font-family: 'Roboto', sans-serif; 
            background-color: var(--md-sys-color-surface);
            color: #1C1B1F;
            margin: 0; padding: 0;
            overflow-x: hidden;
            overscroll-behavior-y: none;
            -webkit-tap-highlight-color: transparent;
        }

        .page { 
            display: none; width: 100%; min-height: 100vh;
            padding: 20px; box-sizing: border-box; 
            padding-bottom: calc(90px + var(--safe-area-bottom));
            opacity: 0; transition: opacity 0.2s ease-in-out;
        }
        
        .active { 
            display: block; opacity: 1;
            animation: slideUp 0.3s cubic-bezier(0.2, 0.0, 0, 1.0); 
        }

        @keyframes slideUp { from { transform: translateY(20px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }

        h2 { font-weight: 500; color: var(--md-sys-color-primary); text-align: center; margin-bottom: 24px; }

        .card { 
            background: var(--md-sys-color-surface-container); 
            padding: 20px; border-radius: 24px; margin-bottom: 16px; 
            box-shadow: 0 1px 3px rgba(0,0,0,0.05);
        }

        .label { font-size: 0.75rem; font-weight: 700; text-transform: uppercase; color: var(--md-sys-color-primary); display: block; margin-top: 10px; letter-spacing: 0.5px; }

        input { 
            background: white; border: 1.5px solid transparent; border-radius: 16px; 
            padding: 16px; margin: 8px 0; width: 100%; box-sizing: border-box; 
            font-size: 16px; transition: all 0.2s; box-shadow: 0 1px 2px rgba(0,0,0,0.05);
            appearance: none;
        }
        input:focus { border-color: var(--md-sys-color-primary); outline: none; box-shadow: 0 0 0 4px rgba(103, 80, 164, 0.1); }

        /* --- ROW STYLING --- */
        .plate-row { display: flex; gap: 8px; align-items: center; margin-bottom: 8px; }
        .split-box { width: 60px !important; text-align: center; font-weight: bold; color: var(--md-sys-color-primary); padding: 16px 5px !important; }
        .btn-remove {
            background: #ffebee; color: var(--md-sys-color-error);
            border: none; border-radius: 12px;
            width: 44px; height: 54px; /* Matches input height */
            font-size: 1.5rem; line-height: 1; cursor: pointer;
            display: flex; align-items: center; justify-content: center;
        }

        .switch-group { display: flex; flex-direction: column; gap: 16px; margin: 15px 0; }
        .switch-container { display: flex; justify-content: space-between; align-items: center; }
        .switch { position: relative; display: inline-block; width: 52px; height: 32px; }
        .switch input { opacity: 0; width: 0; height: 0; }
        .slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: #E0E0E0; transition: .3s; border-radius: 34px; }
        .slider:before { position: absolute; content: ""; height: 24px; width: 24px; left: 4px; bottom: 4px; background-color: white; transition: .3s; border-radius: 50%; box-shadow: 0 2px 4px rgba(0,0,0,0.2); }
        input:checked + .slider { background-color: var(--md-sys-color-primary); }
        input:checked + .slider:before { transform: translateX(20px); }

        .bottom-bar {
            position: fixed; bottom: 0; left: 0; right: 0;
            background: rgba(255, 255, 255, 0.95); backdrop-filter: blur(10px);
            padding: 16px 24px; padding-bottom: max(16px, var(--safe-area-bottom));
            display: flex; gap: 12px; box-shadow: 0 -4px 20px rgba(0,0,0,0.05); z-index: 1000;
        }

        button:active { transform: scale(0.98); opacity: 0.9; }

        .btn-full { flex: 1; border-radius: 100px; padding: 16px; font-weight: 600; border: none; cursor: pointer; font-size: 1rem; letter-spacing: 0.5px; }
        .btn-primary { background: var(--md-sys-color-primary); color: white; box-shadow: 0 4px 12px rgba(103, 80, 164, 0.3); }
        .btn-tonal { background: var(--md-sys-color-secondary-container); color: #1D192B; }
        .btn-whatsapp { background: var(--md-sys-color-whatsapp); color: white; box-shadow: 0 4px 12px rgba(37, 211, 102, 0.3); }
        .btn-small { background: none; color: var(--md-sys-color-primary); border: none; font-weight: 700; padding: 12px; cursor: pointer; width: 100%; }

        .result-item { padding: 16px 0; border-bottom: 1px solid #EEE; }
        .payment-status { font-weight: 700; font-size: 0.85rem; margin-top: 6px; display: inline-block; padding: 4px 8px; border-radius: 6px; }
        .owed { color: var(--md-sys-color-error); background: #fce8e6; }
        .change { color: var(--md-sys-color-success); background: #e8f5e9; }
        .paid-input-mini { width: 90px !important; padding: 10px !important; margin: 0 !important; font-weight: bold; text-align: right; }
        .grand-total { font-size: 3rem; font-weight: 700; text-align: center; margin: 10px 0; color: var(--md-sys-color-primary); letter-spacing: -1px; }
    </style>
</head>
<body>

    <div id="page1" class="page active">
        <h2 style="margin-top: 60px;">Split EGP</h2>
        <div class="card">
            <span class="label">Number of People</span>
            <input type="number" id="peopleCount" min="1" inputmode="numeric" placeholder="How many people?">
            <button class="btn-full btn-primary" onclick="initApp()" style="margin-top: 20px;">Get Started</button>
        </div>
    </div>

    <div id="page2" class="page">
        <h2>Bill Details</h2>
        <div id="peopleInputsContainer"></div>
        
        <div class="card" style="border: 2px dashed var(--md-sys-color-primary);">
            <span class="label">Shared Items</span>
            <div id="commonContainer"></div> <button class="btn-small" onclick="vibrate(); addCommonItem()">+ ADD SHARED ITEM</button>
        </div>

        <div class="card">
            <div class="switch-group">
                <div class="switch-container">
                    <span style="font-weight: 500;">Service Charge (12%)</span>
                    <label class="switch"><input type="checkbox" id="serviceToggle" checked onchange="vibrate(); saveState()"><span class="slider"></span></label>
                </div>
                <div class="switch-container">
                    <span style="font-weight: 500;">VAT Tax (14%)</span>
                    <label class="switch"><input type="checkbox" id="taxToggle" checked onchange="vibrate(); saveState()"><span class="slider"></span></label>
                </div>
            </div>
            <span class="label">Total Table Tip</span>
            <input type="number" id="totalTipValue" placeholder="EGP" inputmode="numeric" oninput="saveState()">
        </div>

        <div class="bottom-bar">
            <button class="btn-full btn-tonal" onclick="vibrate(); resetAndGoBack()">Back</button>
            <button class="btn-full btn-primary" onclick="vibrate(); calculateAndShowResults()">Calculate</button>
        </div>
    </div>

    <div id="page3" class="page">
        <h2>Payment Summary</h2>
        <div class="card">
            <div id="resultsList"></div>
            <div class="grand-total" id="grandTotalDisplay">0</div>
            <div style="text-align: center; font-size: 0.8rem; color: #888; font-weight: 700; margin-top: -5px;">TOTAL EGP</div>
            <button onclick="vibrate(); resetAndGoBack()" style="background:none; border:none; color:var(--md-sys-color-error); font-weight:700; width:100%; margin-top:24px; padding:12px;">ðŸ—‘ START NEW BILL</button>
        </div>

        <div class="bottom-bar">
            <button class="btn-full btn-tonal" onclick="vibrate(); showPage(2)">Back</button>
            <button class="btn-full btn-whatsapp" onclick="vibrate(); shareToWhatsApp()">Share to WhatsApp</button>
        </div>
    </div>

    <script>
        let peopleData = [];
        let commonItems = [0];

        function vibrate() { if (navigator.vibrate) navigator.vibrate(5); }

        window.onload = function() {
            const saved = localStorage.getItem('splitEgpData');
            if (saved) {
                const data = JSON.parse(saved);
                if (data.currentPage > 1) restoreState(data);
            }
        };

        function saveState(pageNum) {
            if(!pageNum) {
                if(document.getElementById('page2').classList.contains('active')) pageNum = 2;
                else if(document.getElementById('page3').classList.contains('active')) pageNum = 3;
                else pageNum = 1;
            }
            const state = {
                peopleData: peopleData,
                commonItems: commonItems,
                service: document.getElementById('serviceToggle').checked,
                tax: document.getElementById('taxToggle').checked,
                tip: document.getElementById('totalTipValue').value,
                currentPage: pageNum
            };
            localStorage.setItem('splitEgpData', JSON.stringify(state));
        }

        function restoreState(data) {
            peopleData = data.peopleData;
            commonItems = data.commonItems;
            
            // Render Structure
            const container = document.getElementById('peopleInputsContainer');
            container.innerHTML = '';
            peopleData.forEach((person, pIdx) => {
                const div = document.createElement('div');
                div.className = 'card';
                div.innerHTML = `
                    <input type="text" value="${person.name}" onchange="peopleData[${pIdx}].name = this.value; saveState()" style="font-weight:700; border:none; font-size:1.1rem; background:transparent; width:100%;">
                    <div style="display:flex; justify-content:space-between; margin-bottom:4px;"><span class="label">Dish Price</span><span class="label">Divide by</span></div>
                    <div id="plates-container-${pIdx}"></div>
                    <button class="btn-small" onclick="vibrate(); addPlateInput(${pIdx})">+ ADD PLATE</button>
                `;
                container.appendChild(div);
                renderPlates(pIdx);
            });

            renderCommon();

            document.getElementById('serviceToggle').checked = data.service;
            document.getElementById('taxToggle').checked = data.tax;
            document.getElementById('totalTipValue').value = data.tip;

            showPage(data.currentPage);
            if(data.currentPage === 3) calculateAndShowResults();
        }

        function resetAndGoBack() {
            localStorage.removeItem('splitEgpData');
            location.reload(); 
        }

        function showPage(num) {
            document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
            document.getElementById('page' + num).classList.add('active');
            window.scrollTo(0,0);
            saveState(num);
        }

        // --- RENDER FUNCTIONS (Handles UI Updates for Add/Remove) ---

        function renderPlates(pIdx) {
            const container = document.getElementById(`plates-container-${pIdx}`);
            container.innerHTML = '';
            peopleData[pIdx].plates.forEach((plate, plIdx) => {
                const row = document.createElement('div');
                row.className = 'plate-row';
                // Only show remove button if there's more than 1 plate, OR always show it? 
                // Let's always show it, but if it's the last one, maybe we handle empty array?
                // For simplicity, we allow deleting all. If empty, it's 0.
                row.innerHTML = `
                    <input type="number" step="0.01" value="${plate.val || ''}" placeholder="Price" oninput="updatePlate(${pIdx}, ${plIdx}, 'val', this.value)" inputmode="decimal">
                    <input type="number" value="${plate.div}" min="1" class="split-box" oninput="updatePlate(${pIdx}, ${plIdx}, 'div', this.value)" inputmode="numeric">
                    <button class="btn-remove" onclick="removePlate(${pIdx}, ${plIdx})">Ã—</button>
                `;
                container.appendChild(row);
            });
        }

        function renderCommon() {
            const container = document.getElementById('commonContainer');
            container.innerHTML = '';
            commonItems.forEach((val, idx) => {
                const row = document.createElement('div');
                row.className = 'plate-row';
                row.innerHTML = `
                    <input type="number" step="0.01" value="${val || ''}" placeholder="EGP" oninput="updateCommon(${idx}, this.value)" inputmode="decimal">
                    <button class="btn-remove" onclick="removeCommon(${idx})">Ã—</button>
                `;
                container.appendChild(row);
            });
        }

        // --- DATA MANIPULATION ---

        function initApp() {
            vibrate();
            const count = document.getElementById('peopleCount').value;
            if(!count || count < 1) return alert("Enter count");
            generateInputs(count);
            showPage(2);
        }

        function generateInputs(count) {
            const container = document.getElementById('peopleInputsContainer');
            container.innerHTML = '';
            peopleData = [];
            commonItems = [0]; // Reset common
            for (let i = 0; i < count; i++) {
                peopleData.push({ name: `Person ${i+1}`, plates: [{val: 0, div: 1}], roundedTotal: 0, paid: 0 });
                const div = document.createElement('div');
                div.className = 'card';
                div.innerHTML = `
                    <input type="text" value="Person ${i+1}" onchange="peopleData[${i}].name = this.value; saveState()" style="font-weight:700; border:none; font-size:1.1rem; background:transparent; width:100%;">
                    <div style="display:flex; justify-content:space-between; margin-bottom:4px;"><span class="label">Dish Price</span><span class="label">Divide by</span></div>
                    <div id="plates-container-${i}"></div>
                    <button class="btn-small" onclick="vibrate(); addPlateInput(${i})">+ ADD PLATE</button>
                `;
                container.appendChild(div);
                renderPlates(i);
            }
            renderCommon();
            saveState();
        }

        function addPlateInput(pIdx) {
            peopleData[pIdx].plates.push({val: 0, div: 1});
            renderPlates(pIdx);
            saveState();
        }

        function removePlate(pIdx, plIdx) {
            vibrate();
            peopleData[pIdx].plates.splice(plIdx, 1);
            renderPlates(pIdx);
            saveState();
        }

        function updatePlate(pIdx, plIdx, key, val) {
            peopleData[pIdx].plates[plIdx][key] = parseFloat(val) || (key === 'div' ? 1 : 0);
            saveState();
        }

        function addCommonItem() {
            commonItems.push(0);
            renderCommon();
            saveState();
        }

        function removeCommon(idx) {
            vibrate();
            commonItems.splice(idx, 1);
            renderCommon();
            saveState();
        }

        function updateCommon(idx, val) { 
            commonItems[idx] = parseFloat(val) || 0; 
            saveState();
        }

        function updatePaidStatus(idx, paidValue) {
            const paid = parseFloat(paidValue) || 0;
            peopleData[idx].paid = paid; 
            const diff = paid - peopleData[idx].roundedTotal;
            const statusEl = document.getElementById(`status-${idx}`);
            if (paid === 0) statusEl.innerHTML = "";
            else if (diff < 0) statusEl.innerHTML = `<span class="payment-status owed">Still owes ${Math.abs(diff)} EGP</span>`;
            else if (diff > 0) statusEl.innerHTML = `<span class="payment-status change">Change due: ${diff} EGP</span>`;
            else statusEl.innerHTML = `<span class="payment-status change">âœ“ Fully Paid</span>`;
            saveState();
        }

        function calculateAndShowResults() {
            const numPeople = peopleData.length;
            const useService = document.getElementById('serviceToggle').checked;
            const useTax = document.getElementById('taxToggle').checked;
            const sharePerPerson = commonItems.reduce((a, b) => a + b, 0) / numPeople;
            const tipPerPerson = (parseFloat(document.getElementById('totalTipValue').value) || 0) / numPeople;
            
            let totalRoundedSum = 0;
            const resultsList = document.getElementById('resultsList');
            resultsList.innerHTML = '';

            peopleData.forEach((person, i) => {
                const individualFood = person.plates.reduce((sum, p) => sum + (p.val / p.div), 0);
                const foodSubtotal = individualFood + sharePerPerson;
                const service = useService ? (foodSubtotal * 0.12) : 0;
                const tax = useTax ? ((foodSubtotal + service) * 0.14) : 0;
                
                person.roundedTotal = Math.round(foodSubtotal + service + tax + tipPerPerson);
                totalRoundedSum += person.roundedTotal;

                const row = document.createElement('div');
                row.className = 'result-item';
                row.innerHTML = `
                    <div style="display:flex; justify-content:space-between; align-items:center;">
                        <div>
                            <strong>${person.name}: ${person.roundedTotal} EGP</strong>
                            <div style="font-size:0.7rem; color:#888;">Exact: ${(foodSubtotal + service + tax + tipPerPerson).toFixed(2)}</div>
                        </div>
                        <input type="number" class="paid-input-mini" placeholder="Paid?" value="${person.paid || ''}" oninput="updatePaidStatus(${i}, this.value)" inputmode="decimal">
                    </div>
                    <div id="status-${i}"></div>
                `;
                resultsList.appendChild(row);
                
                if(person.paid > 0) updatePaidStatus(i, person.paid);
            });

            document.getElementById('grandTotalDisplay').innerText = totalRoundedSum;
            showPage(3);
        }

        function shareToWhatsApp() {
            let msg = "*Split Summary (EGP)* ðŸ§¾\n\n";
            peopleData.forEach((person, i) => {
                const paid = person.paid || 0;
                const diff = paid - person.roundedTotal;
                let status = "";
                if (paid > 0) {
                    if (diff < 0) status = ` (Still owes ${Math.abs(diff)} EGP)`;
                    else if (diff > 0) status = ` (Change due: ${diff} EGP)`;
                    else status = ` (Fully Paid âœ“)`;
                }
                msg += `â€¢ *${person.name}*: ${person.roundedTotal} EGP${status}\n`;
            });
            msg += `\n*Grand Total: ${document.getElementById('grandTotalDisplay').innerText} EGP*`;
            window.open(`https://wa.me/?text=${encodeURIComponent(msg)}`, '_blank');
        }

        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => { navigator.serviceWorker.register('sw.js'); });
        }
    </script>
</body>
</html>